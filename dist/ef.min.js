var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};require("lovefield");var WebEF;!function(t){function e(t,n,a,r){if(a||(a=0),0===a||r&&!n(r,t))if(a++,p.array(t))for(var i=0;i<t.length;i++){var o=t[i];e(o,n,a)}else if(p.object(t))for(var s in t)if(p.property(t,s)){var o=t[s];e(o,n,a,s)}}var n=function(){function t(){}return t.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n,i,o;n=t[0],i=t[1],o=t[2];var s=lf.schema.create(n,i),c={},h={},l={},u={},p=[],b={};for(var d in o){var m=o[d],v=s.createTable(d);p.push(d);var y=[],x=[];c[d]=[],h[d]={},l[d]={},b[d]={};var g=[];for(var S in m){var N=f.removeWhiteSpace(m[S]),T=!0,k=!1;if(0===N.indexOf("pkey"))v.addColumn(S,lf.Type.INTEGER),k=!0,g.push(S),u[d]=S;else if(0===N.indexOf("string"))v.addColumn(S,lf.Type.STRING);else if(0===N.indexOf("date"))v.addColumn(S,lf.Type.DATE_TIME);else if(0===N.indexOf("boolean"))v.addColumn(S,lf.Type.BOOLEAN);else if(0===N.indexOf("int"))v.addColumn(S,lf.Type.INTEGER);else if(0===N.indexOf("float"))v.addColumn(S,lf.Type.NUMBER);else if(0===N.indexOf("object"))v.addColumn(S,lf.Type.OBJECT);else if(0===N.indexOf("array"))v.addColumn(S,lf.Type.ARRAY_BUFFER);else if(0===N.indexOf("fkey")){v.addColumn(S,lf.Type.INTEGER),y.push(S);var w=N.split(":")[1].split(".");l[d][S]={columnName:S,fkTable:w[0],fkColumn:w[1]}}else if(0==N.indexOf("nav->")){T=!1;var w=N.split(">")[1].split(":"),I=w[1].split("."),O=w[0],_=I[0],q=I[1];h[d][S]={columnName:S,tableName:O,fkTable:_,fkColumn:q,isArray:_===O}}else 0===N.indexOf("dbtimestamp")?(v.addColumn(S,lf.Type.INTEGER),b[d].dbtimestamp=S):0===N.indexOf("isdeleted")&&(v.addColumn(S,lf.Type.BOOLEAN),b[d].isdeleted=S);if(T){var E=N.split(",");if(-1!==E.indexOf("index")){-1!==E.indexOf("unique");x.push(S)}-1!==E.indexOf("null")&&y.push(S),c[d].push(S)}}if(0===g.length)throw"Schema Error: no primary key was specified for table '"+d+"'";if(g.length>1)throw"Schema Error: more than one primary key was specified for table '"+d+"'";v.addPrimaryKey(g),v.addNullable(y),v.addIndex("ix_"+d,x)}s.createTable("__dbstate").addColumn("id",lf.Type.STRING).addColumn("value",lf.Type.STRING).addPrimaryKey(["id"]),a.instanceMap[n]=new r(n,i,s,c,h,p,l,b,u)},t}();t.DBSchema=n;var a=function(){function t(){}return t.instanceMap={},t}(),r=function(){function t(t,e,n,a,r,i,o,s,c){this.dbName=t,this.dbVersion=e,this.schemaBuilder=n,this.schema=a,this.nav=r,this.tables=i,this.fk=o,this.options=s,this.pk=c}return t.prototype.newTableMap=function(){for(var t={},e=0;e<this.tables.length;e++)t[this.tables[e]]=[];return t},t}(),i=function(){function t(t,e,n){var r=this;this.loading=!1,this.loaded=!1,this.context=new o,this.context.dbStoreType=void 0===e?lf.schema.DataStoreType.INDEXED_DB:e,this.context.dbInstance=a.instanceMap[t],this.context.DEBUG=n;var i=this;this.ready=new Promise(function(t,e){try{r.context.dbInstance.schemaBuilder.connect({storeType:i.context.dbStoreType}).then(function(e){r.context.db=e,r.context.tableSchemaMap=r.context.dbInstance.newTableMap(),r.context.tables=[];for(var n in r.context.tableSchemaMap){var a=e.getSchema().table(n);r.context.tableSchemaMap[n]=a,r.context.tables.push(a)}r.context.dbStateTable=e.getSchema().table("__dbstate"),e.select().from(r.context.dbStateTable).exec().then(function(e){r.context.initState(e),t()})})}catch(n){e(n)}})}return t.prototype.purge=function(){var t=this.context.db.createTransaction(),e=[];for(var n in this.context.tableSchemaMap){var a=this.context.tableSchemaMap[n];e.push(this.context.db["delete"]().from(a)),this.context.purgeKeys(n)}return this.context.purgeKeys("dbtimestamp"),t.exec(e)},t.prototype.transaction=function(t){var e=this;return this.context.tx=this.context.db.createTransaction(),this.context.tx.begin(this.context.tables).then(function(){var n=t(e.context.tx,e.context.tableSchemaMap).then(function(){e.context.tx.commit(),e.context.tx=void 0});return n})},Object.defineProperty(t.prototype,"tables",{get:function(){return this.context.tableSchemaMap},enumerable:!0,configurable:!0}),t.prototype.select=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.context.db.select.apply(this.context.db,t)},t.prototype.getCheckpoint=function(){var t=this;return new Promise(function(e,n){var a=""+t.context.dbInstance.dbName+t.context.dbStoreType+".dbtimestamp.masterIndex";t.context.db.select().from(t.context.dbStateTable).where(t.context.dbStateTable.id.eq(a)).limit(1).exec().then(function(t){if(t&&t[0]){var n=t[0].value;e(n)}else e(0)})})},t.prototype.getSetting=function(t){return this.context.getStateRaw(t)},t.prototype.saveSetting=function(t,e){return this.context.setStateRaw(t,e)},t.prototype.DBEntity=function(t,e){return new s(this.context,t,e,this.ready)},t}();t.DBContext=i;var o=function(){function t(){this.dbStateObject={}}return t.prototype.log=function(t){this.DEBUG&&console.log(t.toSql())},t.prototype.compose=function(t,e,n){var a=n[t];if(void 0===a)return e;var r=a.column2;e[0]&&void 0===e[0][t][r]&&(r=a.column1);for(var i=[],o=[],s={},c=0;c<e.length;c++){var h=e[c],l=h[t][r];if(void 0===s[l]){s[l]=i.length;var u=h[t],p=JSON.parse(JSON.stringify(u));i.push(p)}var f=s[l];void 0===o[f]&&(o[f]=[]),o[f].push(h)}for(var b in s){var d=s[b];e=o[d];for(var m=0;m<e.length;m++){var v=JSON.parse(JSON.stringify(e[m]));this.compose_(t,v,i[d])}}return i},t.prototype.compose_=function(t,e,n){var a=this.dbInstance.nav[t];for(var r in a){var i=a[r],o=e[i.tableName],s=this.dbInstance.pk[i.tableName];if(o){var c=o[s],h=null!==c;if(h)if(i.isArray){var l=n[i.columnName];if(p.undefined(l))n[i.columnName]=[o],this.compose_(i.tableName,e,o);else{var u=l.map(function(t,e){return t[s]}),f=u.indexOf(c);-1===f?(l.push(o),this.compose_(i.tableName,e,o)):this.compose_(i.tableName,e,l[f])}}else n[i.columnName]=o,this.compose_(i.tableName,e,o)}}},t.prototype.decompose=function(t,e){for(var n=this.dbInstance.newTableMap(),a=0;a<e.length;a++){var r=e[a];n[t].push(r),this.decompose_(t,r,n)}return n},t.prototype.decompose_=function(t,e,n){for(var a in e){var r=this.dbInstance.nav[t][a];if(void 0!==r){var i=e[a];if(p.array(i))for(var o=0;o<i.length;o++)n[r.tableName].push(i[o]),this.decompose_(r.tableName,i[o],n);else p.object(i)&&(n[r.tableName].push(i),this.decompose_(r.tableName,i,n))}}},t.prototype.initState=function(t){for(var e=0;e<t.length;e++){var n=t[e].id,a=t[e].value;this.dbStateObject[n]=a}},t.prototype.getState=function(t){var e=this.dbStateObject[t];return p.undefined(e)||p.empty(e)?0:parseInt(this.dbStateObject[t])},t.prototype.getStateRaw=function(t){return this.dbStateObject[t]},t.prototype.setState=function(t,e){this.dbStateObject[t]=e.toString(),this.setDbState(t,e.toString())},t.prototype.setStateRaw=function(t,e){this.dbStateObject[t]=e,this.setDbState(t,e)},t.prototype.dbState=function(t){var e=this;return new Promise(function(n,a){e.db.select().from(e.dbStateTable).where(e.dbStateTable.id.eq(t)).limit(1).exec().then(function(t){if(t&&t[0]){var e=t[0].value;n(parseInt(e))}else n(0)})})},t.prototype.setDbState=function(t,e){var n=this.dbStateTable.createRow({id:t,value:e});return this.db.insertOrReplace().into(this.dbStateTable).values([n]).exec()},t.prototype.dbStateKey=function(t){return""+this.dbInstance.dbName+this.dbStoreType+"."+t+".masterIndex"},t.prototype.allocateKeys=function(t,e){var n=this.dbStateKey(t),a=this.getState(n),r=a||1,i=r;return e||(e=1),i+=e,this.setState(n,i),r},t.prototype.rollbackKeys=function(t,e){var n=this.dbStateKey(t);this.setState(n,e-1)},t.prototype.purgeKeys=function(t){var e=""+this.dbInstance.dbName+this.dbStoreType+"."+t+".masterIndex";return this.db["delete"]().from(this.dbStateTable).where(this.dbStateTable.id.eq(e)).exec()},t.prototype.exec=function(t){return this.log(t),this.tx?this.tx.attach(t):t.exec()},t.prototype.execMany=function(t){for(var e=0;e<t.length;e++)this.log(t[e]);if(this.tx)return t=t.reverse(),this._execMany(t);var n=this.db.createTransaction();return n.exec(t)},t.prototype._execMany=function(t){var e=this,n=t.pop(),a=this.tx.attach(n);return 0===t.length?a:a.then(function(){return e.execMany(t)})},t}(),s=function(){function t(t,n,a,r){var i=this;this.navigationProperties=[],this.navigationTables=[],this.tables=[],this.join=[],this.tblmap={},this.context=t,this.tableName=n,this.navigationProperties=a||[],this.nav=t.dbInstance.nav[n];var o=JSON.parse(JSON.stringify(this.nav));e(o,function(e,n){if("tableName"===e){var a=t.dbInstance.nav[n];for(var r in a)p.property(a,r)&&(o[r]||-1===i.navigationProperties.indexOf(a[r].tableName)||(o[r]=a[r]))}}),this.pk=t.dbInstance.pk[n];for(var s in o)this.navigationTables.push(o[s].tableName);for(var c=0;c<this.navigationTables.length;c++)this.tables.push(this.navigationTables[c]);this.tables.push(this.tableName),this.fkmap={};for(var c=0;c<this.tables.length;c++){var n=this.tables[c],h=this.context.dbInstance.fk[n];for(var s in h){var l=h[s];-1!==this.tables.indexOf(l.fkTable)&&(this.fkmap[n]||(this.fkmap[n]={table1:n,column1:s,table2:l.fkTable,column2:l.fkColumn}),this.fkmap[l.fkTable]||(this.fkmap[l.fkTable]={table1:l.fkTable,column1:l.fkColumn,table2:n,column2:s}))}}this.tables.sort(function(t,e){var n=i.fkmap[t],a=i.fkmap[e];return n.table2===e?-1:a.table2===t?1:0}),r.then(function(){var e=t.tableSchemaMap[i.tableName];for(var n in e)i[n]=e[n];i.tblmap[i.tableName]=e;for(var a=0;a<i.navigationTables.length;a++){var r=i.navigationTables[a];i.tblmap[r]=i.context.tableSchemaMap[r]}for(var a=0;a<i.navigationTables.length;a++){var r=i.navigationTables[a],o=i.fkmap[r];if(o){var s={table:i.tblmap[r],predicateleft:i.tblmap[o.table2][o.column2],predicateright:i.tblmap[o.table1][o.column1]};i.join.push(s)}}})}return t.prototype.put=function(t){var e,n=this;e=p.array(t)?t:[t];var a=this.context.decompose(this.tableName,e),r={};for(var i in a){var o=a[i];o.length>0&&(r[i]=this.put_calculateKeys(o,i))}for(var s=0;s<e.length;s++)this.put_calculateForeignKeys(this.tableName,e[s]);for(var c=[],s=0;s<this.tables.length;s++){var h=this.tables[s],l=a[h];l.length>0&&c.push(this.put_execute(l,h,this.context.db,r))}return this.context.execMany(c).then(function(e){return t},function(t){for(var e in a){var i=r[e];i&&(i.dbtsIndex&&n.context.rollbackKeys("dbtimestamp",i.dbtsIndex),n.context.rollbackKeys(e,i.index))}throw t})},t.prototype.put_calculateForeignKeys=function(t,e,n,a){function r(t,e,n,a,r,i){for(var o in a){var s=a[o];s.fkTable===r&&(e[o]=t[s.fkColumn])}for(var o in n){var s=n[o];s.fkTable===i&&(t[o]=e[s.fkColumn])}}for(var i in e){var o=this.context.dbInstance.nav[t][i];if(void 0!==o){var s=this.context.dbInstance.fk[o.tableName],c=this.context.dbInstance.fk[t],h=e[i];if(n=e,p.array(h))for(var l=0;l<h.length;l++)r(h[l],e,s,c,o.tableName,t),this.put_calculateForeignKeys(o.tableName,h[l],n,t);else p.object(h)&&(r(h,e,s,c,o.tableName,t),this.put_calculateForeignKeys(o.tableName,h,n,t))}}},t.prototype.put_calculateKeys=function(t,e){for(var n=this.context.dbInstance.pk[e],a=[],r=0;r<t.length;r++)void 0===t[r][n]&&a.push(r);var i=this.context.dbInstance.options[e].isdeleted;if(i)for(var r=0;r<t.length;r++)t[r][i]=!1;var o,s,c=this.context.dbInstance.options[e].dbtimestamp;if(c){s=this.context.allocateKeys("dbtimestamp",t.length);for(var r=0;r<t.length;r++)t[r][c]=s+r}o=this.context.allocateKeys(e,a.length);for(var r=0;r<a.length;r++)t[a[r]][n]=o+r;return{index:o,dbtsIndex:s}},t.prototype.put_execute=function(t,e,n,a){for(var r=this.context.tableSchemaMap[e],i=this.context.dbInstance.schema[e],o=[],s=0;s<t.length;s++){for(var c=t[s],h={},l=0;l<i.length;l++){var u=i[l];h[u]=c[u]}o.push(r.createRow(h))}var p=n.insertOrReplace().into(r).values(o);return p},t.prototype.get=function(t){var e=this;return this._get(t).then(function(n){var a=e.context.compose(e.tableName,n,e.fkmap);return p.array(t)||p.undefined(t)?a:a[0]})},t.prototype._get=function(t,e){var n=this.context.db,a=this.context.tableSchemaMap[this.tableName],r=this._query(n,a),i=this.context.dbInstance.pk[this.tableName],o=this.context.dbInstance.options[this.tableName].isdeleted;return void 0===o?p.array(t)?r.where(a[i]["in"](t)):p.number(t)&&r.where(a[i].eq(t)):p.array(t)?r.where(lf.op.and(a[i]["in"](t),a[o].eq(!1))):p.number(t)?r.where(lf.op.and(a[i].eq(t),a[o].eq(!1))):p.undefined(t)&&!e&&r.where(a[o].eq(!1)),this.context.exec(r)},t.prototype.query=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],a=this._query(e,n);return t(this.tblmap,new l(a,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype.count=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],a=this.context.dbInstance.pk[this.tableName],r=this._query(e,n,[lf.fn.count(n[a])]);return t(this.tblmap,new h(r,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype.select=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],a=this._query(e,n,void 0,!1);return t(this.tblmap[this.tableName],new u(a,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype._query=function(t,e,n,a){void 0===a&&(a=!0);var r=n?t.select.apply(t,n).from(e):t.select().from(e);if(a)for(var i=0;i<this.join.length;i++)r.leftOuterJoin(this.join[i].table,this.join[i].predicateleft.eq(this.join[i].predicateright));return r},t.prototype["delete"]=function(t,e){var n=this;return this._get(t,e).then(function(t){for(var a={},r={},i=0;i<t.length;i++){var o=t[i];for(var s in o){var c=n.context.dbInstance.pk[s],h=o[s],l=h[c];void 0===r[s]?(r[s]=[l],a[s]=[h]):-1===r[s].indexOf(l)&&(r[s].push(l),a[s].push(h))}}var u=n.context.db,p=[];for(var f in a){var c=n.context.dbInstance.pk[f],s=n.tblmap[f],b=r[f],d=n.context.dbInstance.options[f].isdeleted;if(void 0===d||e===!0){var m=u["delete"]().from(s).where(s[c]["in"](b));p.push(m)}else{var m=u.update(s).set(s[d],!0).where(s[c]["in"](b));p.push(m)}}return n.context.execMany(p)})},t}(),c=function(){function t(){}return t.prototype.where=function(t){var e=this.tblmap[this.tableName],n=this.context.dbInstance.options[this.tableName].isdeleted;return void 0===n?this.query.where(t):this.query.where(lf.op.and(t,e[n].eq(!1))),this},t.prototype.explain=function(){return this.query.explain()},t.prototype.toSql=function(){return this.query.toSql()},t}(),h=function(t){function e(e,n,a,r,i){t.call(this),this.query=e,this.context=n,this.tableName=a,this.fkmap=r,this.tblmap=i}return __extends(e,t),e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){var t=this,e=this.context.dbInstance.pk[this.tableName];return this.context.exec(this.query).then(function(n){var a=n[0][t.tableName]["COUNT("+e+")"];return a})},e}(c),l=function(t){function e(e,n,a,r,i){t.call(this),this.query=e,this.context=n,this.tableName=a,this.fkmap=r,this.tblmap=i}return __extends(e,t),e.prototype.groupBy=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.query.groupBy.apply(this,t),this},e.prototype.limit=function(t){return this.query.limit(t),this},e.prototype.orderBy=function(t,e){return this.query.orderBy(t,e),this},e.prototype.skip=function(t){return this.query.skip(t),this},e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){var t=this;return this.context.exec(this.query).then(function(e){var n=t.context.compose(t.tableName,e,t.fkmap);return n})},e}(c),u=function(t){function e(e,n,a,r,i){t.call(this),this.query=e,this.context=n,this.tableName=a,this.fkmap=r,this.tblmap=i}return __extends(e,t),e.prototype.groupBy=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.query.groupBy.apply(this,t),this},e.prototype.limit=function(t){return this.query.limit(t),this},e.prototype.orderBy=function(t,e){return this.query.orderBy(t,e),this},e.prototype.skip=function(t){return this.query.skip(t),this},e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){return this.context.exec(this.query).then(function(t){return t})},e}(c),p=function(){function t(){}return t.array=function(t){return Array.isArray(t)},t.number=function(t){return"number"==typeof t},t.string=function(t){return"string"==typeof t},t.object=function(t){return"object"==typeof t},t.undefined=function(t){return void 0===t},t.empty=function(e){return t.object(e)?0===Object.keys(e).length:t.string(e)?""===e:void 0},t.property=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},t}(),f=function(){function t(){}return t.removeWhiteSpace=function(t){return t.replace(/\s/g,"")},t}();(function(){function t(){}return t.serial=function(){function t(e,n,a){var r=e.pop();if(r){var i=r.splice(0,1)[0],o=r;i.apply(this,o).then(function(){t(e,n,a)})}else n()}for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return 1===e.length&&(e=e[0]),e.reverse(),new Promise(function(n,a){t(e,n,a)})},t})()}(WebEF=exports.WebEF||(exports.WebEF={}));var window=window||self;window.WebEF=WebEF;