var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};require("google/lovefield");var DBSchema=function(){function t(){}return t.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n,r,a;if(3===t.length)n=t[0],r=t[1],a=t[2];else if(1===t.length){var i=Load.json(t[0]);n=i.name,r=i.version,a=i.schema}var o=lf.schema.create(n,r),s={},c={},h={},l={},u=[],p={};for(var f in a){var m=a[f],b=o.createTable(f);u.push(f);var d=[],v=[];s[f]=[],c[f]={},h[f]={},p[f]={};var y=[];for(var x in m){var g=StringUtils.removeWhiteSpace(m[x]),N=!0,S=!1;if(0===g.indexOf("pkey"))b.addColumn(x,lf.Type.INTEGER),S=!0,y.push(x),l[f]=x;else if(0===g.indexOf("string"))b.addColumn(x,lf.Type.STRING);else if(0===g.indexOf("date"))b.addColumn(x,lf.Type.DATE_TIME);else if(0===g.indexOf("boolean"))b.addColumn(x,lf.Type.BOOLEAN);else if(0===g.indexOf("int"))b.addColumn(x,lf.Type.INTEGER);else if(0===g.indexOf("float"))b.addColumn(x,lf.Type.NUMBER);else if(0===g.indexOf("object"))b.addColumn(x,lf.Type.OBJECT);else if(0===g.indexOf("array"))b.addColumn(x,lf.Type.ARRAY_BUFFER);else if(0===g.indexOf("fkey")){b.addColumn(x,lf.Type.INTEGER),d.push(x);var I=g.split(":")[1].split(".");h[f][x]={columnName:x,fkTable:I[0],fkColumn:I[1]}}else if(0==g.indexOf("nav->")){N=!1;var I=g.split(">")[1].split(":"),T=I[1].split("."),k=I[0],w=T[0],_=T[1];c[f][x]={columnName:x,tableName:k,fkTable:w,fkColumn:_,isArray:w===k}}else 0===g.indexOf("dbtimestamp")?(b.addColumn(x,lf.Type.INTEGER),p[f].dbtimestamp=x):0===g.indexOf("isdeleted")&&(b.addColumn(x,lf.Type.BOOLEAN),p[f].isdeleted=x);if(N){var q=g.split(",");if(-1!==q.indexOf("index")){-1!==q.indexOf("unique");v.push(x)}-1!==q.indexOf("null")&&d.push(x),s[f].push(x)}}if(0===y.length)throw"Schema Error: no primary key was specified for table '"+f+"'";if(y.length>1)throw"Schema Error: more than one primary key was specified for table '"+f+"'";b.addPrimaryKey(y),b.addNullable(d),b.addIndex("ix_"+f,v)}DBSchemaInternal.instanceMap[n]=new DBInstance(n,r,o,s,c,u,h,p,l)},t}();exports.DBSchema=DBSchema;var DBSchemaInternal=function(){function t(){}return t.instanceMap={},t}(),DBInstance=function(){function t(t,e,n,r,a,i,o,s,c){this.dbName=t,this.dbVersion=e,this.schemaBuilder=n,this.schema=r,this.nav=a,this.tables=i,this.fk=o,this.options=s,this.pk=c}return t.prototype.newTableMap=function(){for(var t={},e=0;e<this.tables.length;e++)t[this.tables[e]]=[];return t},t}(),DBContext=function(){function t(t,e,n){var r=this;this.loading=!1,this.loaded=!1,this.context=new DBContextInternal,this.context.dbStoreType=void 0===e?lf.schema.DataStoreType.WEB_SQL:e,this.context.dbInstance=DBSchemaInternal.instanceMap[t];var a=1024*(n||1)*1024,i=this;this.ready=new Promise(function(t,e){try{r.context.dbInstance.schemaBuilder.connect({storeType:i.context.dbStoreType,webSqlDbSize:a}).then(function(e){r.context.db=e,r.context.tableSchemaMap=r.context.dbInstance.newTableMap(),r.context.tables=[];for(var n in r.context.tableSchemaMap){var a=r.context.db.getSchema().table(n);r.context.tableSchemaMap[n]=a,r.context.tables.push(a)}t()})}catch(n){e(n)}})}return t.prototype.purge=function(){var t=this.context.db.createTransaction(),e=[];for(var n in this.context.tableSchemaMap){var r=this.context.tableSchemaMap[n];e.push(this.context.db["delete"]().from(r)),this.context.purgeKeys(n)}return this.context.purgeKeys("dbtimestamp"),t.exec(e)},t.prototype.transaction=function(t){var e=this;return this.context.tx=this.context.db.createTransaction(),this.context.tx.begin(this.context.tables).then(function(){var n=t(e.context.tx,e.context.tableSchemaMap).then(function(){e.context.tx.commit(),e.context.tx=void 0});return n})},Object.defineProperty(t.prototype,"tables",{get:function(){return this.context.tableSchemaMap},enumerable:!0,configurable:!0}),t.prototype.select=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.context.db.select.apply(this.context.db,t)},t.prototype.getCheckpoint=function(){if(!localStorage)throw new Error("localstorage not supported!");var t=""+this.context.dbInstance.dbName+this.context.dbStoreType+".dbtimestamp.masterIndex",e=localStorage.getItem(t);if(!e)return 0;var n=parseInt(e);return isNaN(n)?0:n},t.prototype.DBEntity=function(t,e){return new DBEntityInternal(this.context,t,e,this.ready)},t}();exports.DBContext=DBContext;var DBContextInternal=function(){function t(){}return t.prototype.compose=function(t,e,n){var r=n[t];if(void 0===r)return e;for(var a=r.column2,i=[],o=[],s={},c=0;c<e.length;c++){var h=e[c],l=h[t][a];if(void 0===s[l]){s[l]=i.length;var u=h[t],p=JSON.parse(JSON.stringify(u));i.push(p)}var f=s[l];void 0===o[f]&&(o[f]=[]),o[f].push(h)}for(var m in s){var b=s[m];e=o[b];for(var d=0;d<e.length;d++){var v=JSON.parse(JSON.stringify(e[d]));this.compose_(t,v,i[b])}}return i},t.prototype.compose_=function(t,e,n){var r=this.dbInstance.nav[t];for(var a in r){var i=r[a],o=e[i.tableName];o&&(i.isArray?void 0===n[i.columnName]?n[i.columnName]=[o]:n[i.columnName].push(o):n[i.columnName]=o,this.compose_(i.tableName,e,o))}},t.prototype.decompose=function(t,e){for(var n=this.dbInstance.newTableMap(),r=0;r<e.length;r++){var a=e[r];n[t].push(a),this.decompose_(t,a,n)}return n},t.prototype.decompose_=function(t,e,n){for(var r in e){var a=this.dbInstance.nav[t][r];if(void 0!==a){var i=e[r];if(is.array(i))for(var o=0;o<i.length;o++)n[a.tableName].push(i[o]),this.decompose_(a.tableName,i[o],n);else is.object(i)&&(n[a.tableName].push(i),this.decompose_(a.tableName,i,n))}}},t.prototype.allocateKeys=function(t,e){var n,r,a=""+this.dbInstance.dbName+this.dbStoreType+"."+t+".masterIndex",i=window.localStorage.getItem(a);return n=null===i?1:parseInt(i),r=n,e||(e=1),r+=e,window.localStorage.setItem(a,r.toString()),n},t.prototype.rollbackKeys=function(t,e){var n=""+this.dbInstance.dbName+this.dbStoreType+"."+t+".masterIndex";window.localStorage.setItem(n,(e-1).toString())},t.prototype.purgeKeys=function(t){var e=""+this.dbInstance.dbName+this.dbStoreType+"."+t+".masterIndex";localStorage.removeItem(e)},t.prototype.exec=function(t){return this.tx?this.tx.attach(t):t.exec()},t.prototype.execMany=function(t){if(this.tx)return t=t.reverse(),this._execMany(t);var e=this.db.createTransaction();return e.exec(t)},t.prototype._execMany=function(t){var e=this,n=t.pop(),r=this.tx.attach(n);return 0===t.length?r:r.then(function(){return e.execMany(t)})},t}(),DBEntityInternal=function(){function t(t,e,n,r){var a=this;this.navigationProperties=[],this.navigationTables=[],this.tables=[],this.join=[],this.tblmap={},this.context=t,this.tableName=e,this.navigationProperties=n||[],this.nav=t.dbInstance.nav[e],this.pk=t.dbInstance.pk[e];for(var i in this.nav)this.navigationTables.push(this.nav[i].tableName);for(var o=0;o<this.navigationTables.length;o++)this.tables.push(this.navigationTables[o]);this.tables.push(this.tableName),this.fkmap={};for(var o=0;o<this.tables.length;o++){var e=this.tables[o],s=this.context.dbInstance.fk[e];for(var i in s){var c=s[i];-1!==this.tables.indexOf(c.fkTable)&&(this.fkmap[e]={table1:e,column1:i,table2:c.fkTable,column2:c.fkColumn},this.fkmap[c.fkTable]={table1:c.fkTable,column1:c.fkColumn,table2:e,column2:i})}}this.tables.sort(function(t,e){var n=a.fkmap[t],r=a.fkmap[e];return n.table2===e?-1:r.table2===t?1:0}),r.then(function(){var e=t.tableSchemaMap[a.tableName];for(var n in e)a[n]=e[n];a.tblmap[a.tableName]=e;for(var r=0;r<a.navigationTables.length;r++){var i=a.navigationTables[r];a.tblmap[i]=a.context.tableSchemaMap[i]}for(var r=0;r<a.navigationTables.length;r++){var i=a.navigationTables[r],o=a.fkmap[i],s={table:a.tblmap[i],predicateleft:a.tblmap[o.table2][o.column2],predicateright:a.tblmap[o.table1][o.column1]};a.join.push(s)}})}return t.prototype.put=function(t){var e,n=this;e=is.array(t)?t:[t];var r=this.context.decompose(this.tableName,e),a={};for(var i in r){var o=r[i];o.length>0&&(a[i]=this.put_calculateKeys(o,i))}for(var s=0;s<e.length;s++)this.put_calculateForeignKeys(this.tableName,e[s]);for(var c=[],s=0;s<this.tables.length;s++){var i=this.tables[s],o=r[i];o.length>0&&c.push(this.put_execute(o,i,this.context.db,a))}return this.context.execMany(c).then(function(t){var r=e.map(function(t,e,r){return t[n.pk]});return 1===r.length?r[0]:r},function(t){for(var e in r){var i=a[e];i&&(i.dbtsIndex&&n.context.rollbackKeys("dbtimestamp",i.dbtsIndex),n.context.rollbackKeys(e,i.index))}throw t})},t.prototype.put_calculateForeignKeys=function(t,e,n,r){function a(t,e,n,r,a,i){for(var o in r){var s=r[o];s.fkTable===a&&(e[o]=t[s.fkColumn])}for(var o in n){var s=n[o];s.fkTable===i&&(t[o]=e[s.fkColumn])}}for(var i in e){var o=this.context.dbInstance.nav[t][i];if(void 0!==o){var s=this.context.dbInstance.fk[o.tableName],c=this.context.dbInstance.fk[t],h=e[i];if(n=e,is.array(h))for(var l=0;l<h.length;l++)a(h[l],e,s,c,o.tableName,t),this.put_calculateForeignKeys(o.tableName,h[l],n,t);else is.object(h)&&(a(h,e,s,c,o.tableName,t),this.put_calculateForeignKeys(o.tableName,h,n,t))}}},t.prototype.put_calculateKeys=function(t,e){for(var n=this.context.dbInstance.pk[e],r=[],a=0;a<t.length;a++)void 0===t[a][n]&&r.push(a);for(var i=this.context.allocateKeys(e,r.length),a=0;a<r.length;a++)t[r[a]][n]=i+a;var o,s=this.context.dbInstance.options[e].dbtimestamp;if(s){o=this.context.allocateKeys("dbtimestamp",t.length);for(var a=0;a<t.length;a++)t[a][s]=o+a}var c=this.context.dbInstance.options[e].isdeleted;if(c)for(var a=0;a<t.length;a++)t[a][c]=!1;return{index:i,dbtsIndex:o}},t.prototype.put_execute=function(t,e,n,r){for(var a=this.context.tableSchemaMap[e],i=this.context.dbInstance.schema[e],o=[],s=0;s<t.length;s++){for(var c=t[s],h={},l=0;l<i.length;l++){var u=i[l];h[u]=c[u]}o.push(a.createRow(h))}var p=n.insertOrReplace().into(a).values(o);return p},t.prototype.get=function(t){var e=this;return this._get(t).then(function(n){var r=e.context.compose(e.tableName,n,e.fkmap);return is.array(t)||is.undefined(t)?r:r[0]})},t.prototype._get=function(t,e){var n=this.context.db,r=this.context.tableSchemaMap[this.tableName],a=this._query(n,r),i=this.context.dbInstance.pk[this.tableName],o=this.context.dbInstance.options[this.tableName].isdeleted;return void 0===o?is.array(t)?a.where(r[i]["in"](t)):is.number(t)&&a.where(r[i].eq(t)):is.array(t)?a.where(lf.op.and(r[i]["in"](t),r[o].eq(!1))):is.number(t)?a.where(lf.op.and(r[i].eq(t),r[o].eq(!1))):is.undefined(t)&&!e&&a.where(r[o].eq(!1)),this.context.exec(a)},t.prototype.query=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],r=this._query(e,n);return t(this.tblmap,new QueryService(r,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype.count=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],r=this.context.dbInstance.pk[this.tableName],a=this._query(e,n,[lf.fn.count(n[r])]);return t(this.tblmap,new CountService(a,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype.select=function(t){var e=this.context.db,n=this.context.tableSchemaMap[this.tableName],r=this._query(e,n,void 0,!1);return t(this.tblmap[this.tableName],new SelectService(r,this.context,this.tableName,this.fkmap,this.tblmap))},t.prototype._query=function(t,e,n,r){void 0===r&&(r=!0);var a=n?t.select.apply(t,n).from(e):t.select().from(e);if(r)for(var i=0;i<this.join.length;i++)a.innerJoin(this.join[i].table,this.join[i].predicateleft.eq(this.join[i].predicateright));return a},t.prototype["delete"]=function(t,e){var n=this;return this._get(t,e).then(function(t){for(var r={},a={},i=0;i<t.length;i++){var o=t[i];for(var s in o){var c=n.context.dbInstance.pk[s],h=o[s],l=h[c];void 0===a[s]?(a[s]=[l],r[s]=[h]):-1===a[s].indexOf(l)&&(a[s].push(l),r[s].push(h))}}var u=n.context.db,p=[];for(var f in r){var c=n.context.dbInstance.pk[f],s=n.tblmap[f],m=a[f],b=n.context.dbInstance.options[f].isdeleted;if(void 0===b||e===!0){var d=u["delete"]().from(s).where(s[c]["in"](m));p.push(d)}else{var d=u.update(s).set(s[b],!0).where(s[c]["in"](m));p.push(d)}}return n.context.execMany(p)})},t}(),QueryServiceBase=function(){function t(){}return t.prototype.where=function(t){var e=this.tblmap[this.tableName],n=this.context.dbInstance.options[this.tableName].isdeleted;return void 0===n?this.query.where(t):this.query.where(lf.op.and(t,e[n].eq(!1))),this},t.prototype.explain=function(){return this.query.explain()},t.prototype.toSql=function(){return this.query.toSql()},t}(),CountService=function(t){function e(e,n,r,a,i){t.call(this),this.query=e,this.context=n,this.tableName=r,this.fkmap=a,this.tblmap=i}return __extends(e,t),e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){var t=this,e=this.context.dbInstance.pk[this.tableName];return this.context.exec(this.query).then(function(n){var r=n[0][t.tableName]["COUNT("+e+")"];return r})},e}(QueryServiceBase),QueryService=function(t){function e(e,n,r,a,i){t.call(this),this.query=e,this.context=n,this.tableName=r,this.fkmap=a,this.tblmap=i}return __extends(e,t),e.prototype.groupBy=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.query.groupBy.apply(this,t),this},e.prototype.limit=function(t){return this.query.limit(t),this},e.prototype.orderBy=function(t,e){return this.query.orderBy(t,e),this},e.prototype.skip=function(t){return this.query.skip(t),this},e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){var t=this;return this.context.exec(this.query).then(function(e){var n=t.context.compose(t.tableName,e,t.fkmap);return n})},e}(QueryServiceBase),SelectService=function(t){function e(e,n,r,a,i){t.call(this),this.query=e,this.context=n,this.tableName=r,this.fkmap=a,this.tblmap=i}return __extends(e,t),e.prototype.groupBy=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.query.groupBy.apply(this,t),this},e.prototype.limit=function(t){return this.query.limit(t),this},e.prototype.orderBy=function(t,e){return this.query.orderBy(t,e),this},e.prototype.skip=function(t){return this.query.skip(t),this},e.prototype.where=function(e){return t.prototype.where.call(this,e),this},e.prototype.exec=function(){return this.context.exec(this.query).then(function(t){return t})},e}(QueryServiceBase),is=function(){function t(){}return t.array=function(t){return Array.isArray(t)},t.number=function(t){return"number"==typeof t},t.string=function(t){return"string"==typeof t},t.object=function(t){return"object"==typeof t},t.undefined=function(t){return void 0===t},t}(),StringUtils=function(){function t(){}return t.removeWhiteSpace=function(t){return t.replace(/\s/g,"")},t}(),PromiseUtils=function(){function t(){}return t.serial=function(){function t(e,n,r){var a=e.pop();if(a){var i=a.splice(0,1)[0],o=a;i.apply(this,o).then(function(){t(e,n,r)})}else n()}for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return 1===e.length&&(e=e[0]),e.reverse(),new Promise(function(n,r){t(e,n,r)})},t}(),Load=function(){function t(){}return t.json=function(t,e,n){if(n){var r=this.cache[t];if(r)return e?new Promise(function(t,e){t(JSON.parse(r))}):JSON.parse(r)}var a=new XMLHttpRequest;return a.onreadystatechange=function(){return 4==a.readyState&&e?200==a.status?(n&&(this.cache[t]=a.responseText),new Promise(function(t,e){t(JSON.parse(r))})):new Promise(function(t,e){e(a.status)}):void 0},a.open("GET",t,e),a.send(),e?void 0:200==a.status?(n&&(this.cache[t]=a.responseText),JSON.parse(a.responseText)):a.status},t.cache={},t}();